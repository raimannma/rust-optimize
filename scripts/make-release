#!/usr/bin/env bash
set -euo pipefail

usage() {
    echo "Usage: $0 <version|major|minor|patch>"
    echo ""
    echo "Examples:"
    echo "  $0 0.2.0    # Set version to 0.2.0"
    echo "  $0 patch    # Bump patch version (0.1.0 -> 0.1.1)"
    echo "  $0 minor    # Bump minor version (0.1.0 -> 0.2.0)"
    echo "  $0 major    # Bump major version (0.1.0 -> 1.0.0)"
    exit 1
}

[[ $# -ne 1 ]] && usage

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
CARGO_TOML="$ROOT_DIR/Cargo.toml"

# Get current version
CURRENT_VERSION=$(grep -m1 '^version = ' "$CARGO_TOML" | sed 's/version = "\(.*\)"/\1/')
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

# Determine new version
case "$1" in
    major)
        NEW_VERSION="$((MAJOR + 1)).0.0"
        ;;
    minor)
        NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
        ;;
    patch)
        NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
        ;;
    *)
        if [[ "$1" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            NEW_VERSION="$1"
        else
            echo "Error: Invalid version format '$1'"
            usage
        fi
        ;;
esac

echo "Current version: $CURRENT_VERSION"
echo "New version:     $NEW_VERSION"
echo ""

# Check for uncommitted changes
if ! git -C "$ROOT_DIR" diff --quiet || ! git -C "$ROOT_DIR" diff --cached --quiet; then
    echo "Error: You have uncommitted changes. Please commit or stash them first."
    exit 1
fi

# Check if tag already exists
if git -C "$ROOT_DIR" tag -l "v$NEW_VERSION" | grep -q .; then
    echo "Error: Tag v$NEW_VERSION already exists"
    exit 1
fi

# Update version in Cargo.toml
sed -i "s/^version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" "$CARGO_TOML"

# Update Cargo.lock if it exists
if [[ -f "$ROOT_DIR/Cargo.lock" ]]; then
    cargo generate-lockfile --manifest-path "$CARGO_TOML" 2>/dev/null || true
fi

# Commit and tag
git -C "$ROOT_DIR" add "$CARGO_TOML"
git -C "$ROOT_DIR" commit -m "chore: release v$NEW_VERSION"
git -C "$ROOT_DIR" tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"

echo ""
echo "Created release v$NEW_VERSION"
echo ""
echo "To publish, run:"
echo "  git push origin main --tags"
